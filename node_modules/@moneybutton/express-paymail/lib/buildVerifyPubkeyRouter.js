"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.buildVerifyPubkeyRouter = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _express = _interopRequireDefault(require("express"));

var _expressAsyncHandler = _interopRequireDefault(require("express-async-handler"));

// import { PaymailError } from './errors/PaymailError'
// import HttpStatus from 'http-status-codes'
var buildVerifyPubkeyRouter = function buildVerifyPubkeyRouter(config, ifPresent) {
  if (config.verifyPublicKeyOwner) {
    var router = _express["default"].Router();

    router.get('/verifypubkey/:paymail/:pubkey', (0, _expressAsyncHandler["default"])(
    /*#__PURE__*/
    function () {
      var _ref = (0, _asyncToGenerator2["default"])(
      /*#__PURE__*/
      _regenerator["default"].mark(function _callee(req, res) {
        var _req$params$paymail$s, _req$params$paymail$s2, name, domain, pubkey, matchReponse;

        return _regenerator["default"].wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _req$params$paymail$s = req.params.paymail.split('@'), _req$params$paymail$s2 = (0, _slicedToArray2["default"])(_req$params$paymail$s, 2), name = _req$params$paymail$s2[0], domain = _req$params$paymail$s2[1];
                pubkey = req.params.pubkey;
                _context.next = 4;
                return config.verifyPublicKeyOwner(name, domain, pubkey);

              case 4:
                matchReponse = _context.sent;
                res.send({
                  bsvalias: '1.0',
                  handle: req.params.paymail,
                  pubkey: pubkey,
                  match: !!matchReponse
                });

              case 6:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }));

      return function (_x, _x2) {
        return _ref.apply(this, arguments);
      };
    }()));
    ifPresent(router);
  }
};

exports.buildVerifyPubkeyRouter = buildVerifyPubkeyRouter;