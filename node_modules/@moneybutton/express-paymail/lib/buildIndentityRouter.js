"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.buildIdentityRouter = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _express = _interopRequireDefault(require("express"));

var _expressAsyncHandler = _interopRequireDefault(require("express-async-handler"));

var _PaymailError = require("./errors/PaymailError");

var _httpStatusCodes = _interopRequireDefault(require("http-status-codes"));

var buildIdentityRouter = function buildIdentityRouter(config, ifPresent) {
  if (config.getIdentityKey) {
    var router = _express["default"].Router();

    router.get('/id/:paymail', (0, _expressAsyncHandler["default"])(
    /*#__PURE__*/
    function () {
      var _ref = (0, _asyncToGenerator2["default"])(
      /*#__PURE__*/
      _regenerator["default"].mark(function _callee(req, res) {
        var _req$params$paymail$s, _req$params$paymail$s2, name, domain, pubkey;

        return _regenerator["default"].wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                _req$params$paymail$s = req.params.paymail.split('@'), _req$params$paymail$s2 = (0, _slicedToArray2["default"])(_req$params$paymail$s, 2), name = _req$params$paymail$s2[0], domain = _req$params$paymail$s2[1];
                _context.next = 3;
                return config.getIdentityKey(name, domain);

              case 3:
                pubkey = _context.sent;

                if (pubkey) {
                  _context.next = 6;
                  break;
                }

                throw new _PaymailError.PaymailError("Paymail not found: ".concat(req.params.paymail), _httpStatusCodes["default"].NOT_FOUND, 'not-found');

              case 6:
                res.send({
                  bsvalias: '1.0',
                  handle: req.params.paymail,
                  pubkey: pubkey
                });

              case 7:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }));

      return function (_x, _x2) {
        return _ref.apply(this, arguments);
      };
    }()));
    ifPresent(router);
  }
};

exports.buildIdentityRouter = buildIdentityRouter;